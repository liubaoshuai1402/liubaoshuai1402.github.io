document.addEventListener("DOMContentLoaded",function(){if(!window.diagramRenderUtils||!window.diagramRenderUtils.popupWindowUtils){console.error("浮窗工具未加载，请确保diagram_render_utils.html已包含在页面中");return}const e={getPageId:function(){return window.location.pathname},saveNote:function(e){const n=this.getPageId(),t=this.getAllNotes();return t[n]||(t[n]=[]),t[n].push({content:e,timestamp:(new Date).toISOString(),id:Date.now().toString()}),localStorage.setItem("page_notes",JSON.stringify(t)),t[n][t[n].length-1]},getAllNotes:function(){const e=localStorage.getItem("page_notes");return e?JSON.parse(e):{}},getPageNotes:function(){const e=this.getPageId(),t=this.getAllNotes();return t[e]||[]},deleteNote:function(e){const n=this.getPageId(),t=this.getAllNotes();t[n]&&(t[n]=t[n].filter(t=>t.id!==e),localStorage.setItem("page_notes",JSON.stringify(t)))},updateNote:function(e,t){const s=this.getPageId(),n=this.getAllNotes();if(n[s]){const o=n[s].findIndex(t=>t.id===e);o!==-1&&(n[s][o].content=t,n[s][o].updated=(new Date).toISOString(),localStorage.setItem("page_notes",JSON.stringify(n)))}}};function t(t,n){const s=document.createElement("textarea");s.className="note-textarea",s.placeholder="在此处输入笔记...",s.rows=6,s.style.width="calc(100% - 1px)",s.style.resize="vertical",s.style.fontFamily="inherit",s.style.padding="8px",s.style.border="1px solid #ddd",s.style.borderRadius="4px",s.style.boxSizing="border-box";const o=document.createElement("button");o.textContent="保存笔记",o.className="note-save-button",o.style.marginTop="10px",o.style.padding="5px 10px",o.style.backgroundColor="#4CAF50",o.style.color="white",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer";const i=document.createElement("div");i.appendChild(s),i.appendChild(o);const a=window.diagramRenderUtils.popupWindowUtils.create({title:"Note",content:i,x:t,y:n,minWidth:300,maxWidth:"30%",maxHeight:"50%",closeOnClickOutside:!1,closeOnEsc:!0,className:"note-editor resizable"});return o.addEventListener("click",function(){const o=s.value.trim();if(o){const i=e.saveNote(o);a.close();const s=document.createElement("div");s.textContent="笔记已保存！",s.style.padding="10px",s.style.color="#4CAF50",window.diagramRenderUtils.popupWindowUtils.create({title:"保存成功",content:s,x:t,y:n,minWidth:200,closeOnClickOutside:!0,closeOnEsc:!0,onClose:function(){}})}else s.placeholder="请输入笔记内容后再保存",s.style.borderColor="#ff6b6b"}),setTimeout(()=>s.focus(),100),a}function n(n,s){const r=e.getPageNotes(),i=document.createElement("div");if(i.className="notes-list-container",r.length===0){const e=document.createElement("p");e.textContent="当前页面没有保存的笔记",e.style.color="#666",e.style.textAlign="center",e.style.padding="20px 0",i.appendChild(e)}else r.forEach(t=>{const o=document.createElement("div");o.className="note-item",o.style.marginBottom="15px",o.style.padding="10px",o.style.backgroundColor="#f9f9f9",o.style.borderRadius="4px",o.style.border="1px solid #eee";const l=document.createElement("div");l.className="note-content",l.textContent=t.content,l.style.marginBottom="8px",l.style.whiteSpace="pre-wrap";const d=document.createElement("div");d.className="note-time";const u=new Date(t.timestamp);d.textContent=`${u.toLocaleDateString()} ${u.toLocaleTimeString()}`,d.style.fontSize="0.8em",d.style.color="#888";const c=document.createElement("div");c.className="note-actions",c.style.marginTop="8px",c.style.display="flex",c.style.justifyContent="flex-end",c.style.gap="8px";const a=document.createElement("button");a.textContent="编辑",a.className="note-edit-button",a.style.padding="3px 8px",a.style.backgroundColor="#4a90e2",a.style.color="white",a.style.border="none",a.style.borderRadius="3px",a.style.cursor="pointer",a.style.fontSize="0.8em";const r=document.createElement("button");r.textContent="删除",r.className="note-delete-button",r.style.padding="3px 8px",r.style.backgroundColor="#ff6b6b",r.style.color="white",r.style.border="none",r.style.borderRadius="3px",r.style.cursor="pointer",r.style.fontSize="0.8em",c.appendChild(a),c.appendChild(r),o.appendChild(l),o.appendChild(d),o.appendChild(c),i.appendChild(o),a.addEventListener("click",function(){const o=document.createElement("textarea");o.value=t.content,o.rows=6,o.style.width="calc(100% - 1px)",o.style.resize="vertical",o.style.padding="8px",o.style.border="1px solid #ddd",o.style.borderRadius="4px",o.style.boxSizing="border-box";const i=document.createElement("button");i.textContent="更新笔记",i.style.marginTop="10px",i.style.padding="5px 10px",i.style.backgroundColor="#4CAF50",i.style.color="white",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer";const a=document.createElement("div");a.appendChild(o),a.appendChild(i);const r=window.diagramRenderUtils.popupWindowUtils.create({title:"编辑笔记",content:a,x:n,y:s,minWidth:300,maxWidth:"30%",maxHeight:"50%",closeOnClickOutside:!1,closeOnEsc:!0,className:"note-editor resizable"});i.addEventListener("click",function(){const n=o.value.trim();n?(e.updateNote(t.id,n),l.textContent=n,r.close()):(o.placeholder="请输入笔记内容后再保存",o.style.borderColor="#ff6b6b")}),setTimeout(()=>o.focus(),100)}),r.addEventListener("click",function(){const l=document.createElement("div");l.textContent="确定要删除这条笔记吗？",l.style.marginBottom="15px";const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between";const a=document.createElement("button");a.textContent="确定删除",a.style.padding="5px 10px",a.style.backgroundColor="#ff6b6b",a.style.color="white",a.style.border="none",a.style.borderRadius="4px",a.style.cursor="pointer";const r=document.createElement("button");r.textContent="取消",r.style.padding="5px 10px",r.style.backgroundColor="#ccc",r.style.color="white",r.style.border="none",r.style.borderRadius="4px",r.style.cursor="pointer",c.appendChild(r),c.appendChild(a);const d=document.createElement("div");d.appendChild(l),d.appendChild(c);const u=window.diagramRenderUtils.popupWindowUtils.create({title:"确认删除",content:d,x:n,y:s,minWidth:250,closeOnClickOutside:!1,closeOnEsc:!0,className:"note-confirm"});a.addEventListener("click",function(){if(e.deleteNote(t.id),i.removeChild(o),u.close(),e.getPageNotes().length===0){const e=document.createElement("p");e.textContent="当前页面没有保存的笔记",e.style.color="#666",e.style.textAlign="center",e.style.padding="20px 0",i.appendChild(e)}}),r.addEventListener("click",function(){u.close()})})});const o=document.createElement("button");o.textContent="+ 新增笔记",o.style.width="100%",o.style.padding="8px",o.style.marginTop="10px",o.style.backgroundColor="#4CAF50",o.style.color="white",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer";const a=document.createElement("div");a.appendChild(i),a.appendChild(o);const c=window.diagramRenderUtils.popupWindowUtils.create({title:"页面笔记",content:a,x:n,y:s,minWidth:350,maxWidth:"40%",maxHeight:"60%",closeOnClickOutside:!0,closeOnEsc:!0,className:"notes-list resizable"});return o.addEventListener("click",function(){c.close(),t(n,s)}),c}document.addEventListener("contextmenu",function(e){const s=e.target,o=s.tagName.toLowerCase(),i=["a","button","input","textarea","select","img","svg","canvas","video","audio","iframe"],a=["code-rendered-diagram","popup-window"],r=i.includes(o),c=Array.from(s.classList).some(e=>a.some(t=>e.includes(t))),l=s.isContentEditable;if(!r&&!c&&!l){e.preventDefault();const s=document.createElement("div");s.className="note-context-menu",s.style.position="fixed",s.style.zIndex="10001",s.style.backgroundColor="white",s.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",s.style.borderRadius="4px",s.style.padding="5px 0";const i=[{text:"添加笔记",action:()=>t(e.clientX,e.clientY)},{text:"查看所有笔记",action:()=>n(e.clientX,e.clientY)}];i.forEach(e=>{const t=document.createElement("div");t.className="note-context-menu-item",t.textContent=e.text,t.style.padding="8px 15px",t.style.cursor="pointer",t.style.transition="background-color 0.2s",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="#f0f0f0"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="transparent"}),t.addEventListener("click",()=>{document.body.removeChild(s),e.action()}),s.appendChild(t)}),s.style.left=`${e.clientX}px`,s.style.top=`${e.clientY}px`,document.body.appendChild(s);const o=function(e){s.contains(e.target)||(document.body.contains(s)&&document.body.removeChild(s),document.removeEventListener("mousedown",o))};setTimeout(()=>{document.addEventListener("mousedown",o)},100)}})})